<HxAutosuggest
    TItem="LeagueParticipation"
    TValue="int?"
    @bind-Value:get="@Value"
    @bind-Value:set="@ChangeValue"
    DataProvider="ProvideSuggestions"
    ValueSelector="t => t.Id"
    TextSelector='t => $"{t.Player.FirstName} {t.Player.LastName} ({t.Player.Email})"'
    MinimumLength="0"
    ItemFromValueResolver="ItemFromValueResolver"
    Placeholder="Search Existing Player"
    SearchIcon="null">
    <InputGroupEndTemplate>
        @ChildContent
    </InputGroupEndTemplate>
</HxAutosuggest>

@code {
    [Parameter] public int? Value { get; set; }
    [Parameter] public EventCallback<int?> ValueChanged { get; set; }
    [Parameter] public required ICollection<LeagueParticipation> Players { get; set; }
    [Parameter] public required ICollection<LeagueParticipation> PlayersLeft { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private Task<AutosuggestDataProviderResult<LeagueParticipation>> ProvideSuggestions(AutosuggestDataProviderRequest request)
    {
        var match = PlayersLeft.Where(x =>
            x.Player.FirstName.Contains(request.UserInput, StringComparison.InvariantCultureIgnoreCase)
            || x.Player.LastName.Contains(request.UserInput, StringComparison.InvariantCultureIgnoreCase)
            || x.Player.Email.Contains(request.UserInput, StringComparison.InvariantCultureIgnoreCase)).ToList();
        return Task.FromResult(new AutosuggestDataProviderResult<LeagueParticipation> { Data = match });
    }

    private Task<LeagueParticipation?> ItemFromValueResolver(int? value)
    {
        if (value is null)
        {
            return Task.FromResult<LeagueParticipation?>(null);
        }

        return Task.FromResult(Players.FirstOrDefault(x => x.Id == value));
    }

    private void ChangeValue(int? val)
    {
        Value = val;
        ValueChanged.InvokeAsync(val);
    }

}
